# MySQL 性能测试
## 文件系统与操作系统

```
磁盘调度算法设置为 deadline
[root@10.70.1.232 ~]#cat /sys/block/sda/queue/scheduler
noop anticipatory deadline [cfq]

```
## sysstat
```
[root@10.70.1.232 ~]#iostat
-bash: iostat: command not found
[root@10.70.1.232 ~]#
[root@10.70.1.232 ~]#
[root@10.70.1.232 ~]#
[root@10.70.1.232 ~]#yum install sysstat
Loaded plugins: fastestmirror, priorities
Setting up Install Process
Loading mirror speeds from cached hostfile
epel/metalink                                                                                                            | 7.8 kB     00:00
 * base: mirrors.tuna.tsinghua.edu.cn
 * epel: mirrors.ustc.edu.cn
 * extras: mirror.bit.edu.cn
 * updates: mirrors.tuna.tsinghua.edu.cn
base                                                                                                                     | 3.7 kB     00:00
epel                                                                                                                     | 4.7 kB     00:00
epel/primary_db                                                                                                                                             | 6.0 MB     00:08
extras                                                                                                                                                      | 3.4 kB     00:00
updates                                                                                                                                                     | 3.4 kB     00:00
xin                                                                                                                                                         | 2.9 kB     00:00
168 packages excluded due to repository priority protections
Resolving Dependencies
--> Running transaction check
---> Package sysstat.x86_64 0:9.0.4-33.el6 will be installed
--> Finished Dependency Resolution

Dependencies Resolved

===================================================================================================================================================================================
 Package                                   Arch                                     Version                                           Repository                              Size
===================================================================================================================================================================================
Installing:
 sysstat                                   x86_64                                   9.0.4-33.el6                                      base                                   234 k

Transaction Summary
===================================================================================================================================================================================
Install       1 Package(s)

Total download size: 234 k
Installed size: 826 k
Is this ok [y/N]: y
Downloading Packages:
sysstat-9.0.4-33.el6.x86_64.rpm                                                                                                                             | 234 kB     00:00
Running rpm_check_debug
Running Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing : sysstat-9.0.4-33.el6.x86_64                                                                                                                                     1/1
  Verifying  : sysstat-9.0.4-33.el6.x86_64                                                                                                                                     1/1

Installed:
  sysstat.x86_64 0:9.0.4-33.el6

Complete!
[root@10.70.1.232 ~]#iostat -xm 1
Linux 2.6.32-573.el6.x86_64 (moban) 	01/15/2018 	_x86_64_	(4 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.27    0.00    0.08    1.31    0.00   98.34

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda               0.01     2.92    0.06    1.09     0.00     0.02    42.64     0.27  232.88   31.03  244.25  53.86   6.17

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00    0.00    0.00    0.00  100.00

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00    0.25   11.72    0.00   88.03

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda               0.00   110.00    0.00    0.00     0.00     0.00     0.00    70.77    0.00    0.00    0.00   0.00  46.90

^C
[root@10.70.1.232 ~]#

```
## iostat
```
[root@10.70.1.232 ~]#iostat -xm 1 sda
Linux 2.6.32-573.el6.x86_64 (moban) 	01/15/2018 	_x86_64_	(4 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.27    0.00    0.08    1.31    0.00   98.34

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda               0.01     2.91    0.06    1.09     0.00     0.02    42.58     0.27  233.45   31.02  244.82  53.80   6.17

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00    0.00    0.00    0.00  100.00

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00    0.00    0.00    0.00  100.00
           
           

rrqm/s 每秒发起合并读的次数 read request merge
wrqm/s 每秒发起合并写的次数 write request merge

r/s 每秒读的次数
w/s 每秒写的次数

r/s + w /s = iops

rMB/s 
wMB/s 

avgrq-sz 平均请求扇区的大小 每秒请求读取的扇区的数量 每个扇区的大小是512字节  
avgqu-sz 平均队列长度 是平均请求队列的长度。毫无疑问，队列长度越短越好
          
await  等待时间
每一个IO请求的处理的平均时间（单位是微秒毫秒）。这里可以理解为IO的响应时间，一般地系统IO响应时间应该低于5ms，如果大于10ms就比较大了。
         这个时间包括了队列时间和服务时间，也就是说，一般情况下，await大于svctm，它们的差值越小，则说明队列时间越短，反之差值越大，队列时间越长，说明系统出了问题。
         
svctm  服务时间
表示平均每次设备I/O操作的服务时间（以毫秒为单位）。如果svctm的值与await很接近，表示几乎没有I/O等待，磁盘性能很好，如果await的值远高于svctm的值，则表示I/O队列等待太长，         系统上运行的应用程序将变慢。

%util 磁盘使用率
在统计时间内所有处理IO时间，除以总共统计时间。例如，如果统计间隔1秒，该设备有0.8秒在处理IO，而0.2秒闲置，那么该设备的%util = 0.8/1 = 80%，所以该参数暗示了设备的繁忙程度
。一般地，如果该参数是100%表示设备已经接近满负荷运行了（当然如果是多磁盘，即使%util是100%，因为磁盘的并发能力，所以磁盘使用未必就到了瓶颈）。

```

## sysbench

https://github.com/akopytov/sysbench

### 1. install in mac
```
mac:
brew install sysbench
```
### 2. install in centos
```
[root@10.70.1.232 ~]#yum install sysbench
Loaded plugins: fastestmirror, priorities
Setting up Install Process
Loading mirror speeds from cached hostfile
 * base: mirrors.tuna.tsinghua.edu.cn
 * epel: mirrors.ustc.edu.cn
 * extras: mirror.bit.edu.cn
 * updates: mirrors.tuna.tsinghua.edu.cn
168 packages excluded due to repository priority protections
Resolving Dependencies
--> Running transaction check
---> Package sysbench.x86_64 0:1.0.9-2.el6 will be installed
--> Processing Dependency: libmysqlclient_r.so.16(libmysqlclient_16)(64bit) for package: sysbench-1.0.9-2.el6.x86_64
--> Processing Dependency: libck.so.0()(64bit) for package: sysbench-1.0.9-2.el6.x86_64
--> Processing Dependency: libluajit-5.1.so.2()(64bit) for package: sysbench-1.0.9-2.el6.x86_64
--> Processing Dependency: libmysqlclient_r.so.16()(64bit) for package: sysbench-1.0.9-2.el6.x86_64
--> Running transaction check
---> Package ck.x86_64 0:0.5.2-2.el6 will be installed
---> Package luajit.x86_64 0:2.0.4-3.el6 will be installed
---> Package mysql-libs.x86_64 0:5.1.73-8.el6_8 will be installed
--> Finished Dependency Resolution

Dependencies Resolved

===================================================================================================================================================================================
 Package                                     Arch                                    Version                                           Repository                             Size
===================================================================================================================================================================================
Installing:
 sysbench                                    x86_64                                  1.0.9-2.el6                                       epel                                  138 k
Installing for dependencies:
 ck                                          x86_64                                  0.5.2-2.el6                                       epel                                   24 k
 luajit                                      x86_64                                  2.0.4-3.el6                                       epel                                  302 k
 mysql-libs                                  x86_64                                  5.1.73-8.el6_8                                    base                                  1.2 M

Transaction Summary
===================================================================================================================================================================================
Install       4 Package(s)

Total download size: 1.7 M
Installed size: 5.6 M
Is this ok [y/N]: y
Downloading Packages:
(1/4): ck-0.5.2-2.el6.x86_64.rpm                                                                                                                            |  24 kB     00:00
(2/4): luajit-2.0.4-3.el6.x86_64.rpm                                                                                                                        | 302 kB     00:00
(3/4): mysql-libs-5.1.73-8.el6_8.x86_64.rpm                                                                                                                 | 1.2 MB     00:09
(4/4): sysbench-1.0.9-2.el6.x86_64.rpm                                                                                                                      | 138 kB     00:00
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Total                                                                                                                                              162 kB/s | 1.7 MB     00:10
Running rpm_check_debug
Running Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing : mysql-libs-5.1.73-8.el6_8.x86_64                                                                                                                                1/4
warning: /etc/my.cnf created as /etc/my.cnf.rpmnew
  Installing : ck-0.5.2-2.el6.x86_64                                                                                                                                           2/4
  Installing : luajit-2.0.4-3.el6.x86_64                                                                                                                                       3/4
  Installing : sysbench-1.0.9-2.el6.x86_64                                                                                                                                     4/4
  Verifying  : sysbench-1.0.9-2.el6.x86_64                                                                                                                                     1/4
  Verifying  : luajit-2.0.4-3.el6.x86_64                                                                                                                                       2/4
  Verifying  : ck-0.5.2-2.el6.x86_64                                                                                                                                           3/4
  Verifying  : mysql-libs-5.1.73-8.el6_8.x86_64                                                                                                                                4/4

Installed:
  sysbench.x86_64 0:1.0.9-2.el6

Dependency Installed:
  ck.x86_64 0:0.5.2-2.el6                               luajit.x86_64 0:2.0.4-3.el6                               mysql-libs.x86_64 0:5.1.73-8.el6_8

Complete!
[root@10.70.1.232 ~]#sysbench
sysbench 1.0.9 (using system LuaJIT 2.0.4)

```



### fileio
```
 mysqldata git:(master) ✗ sysbench --test=fileio help
WARNING: the --test option is deprecated. You can pass a script name or path on the command line without any options.
sysbench 1.0.11 (using bundled LuaJIT 2.1.0-beta2)

fileio options:
  --file-num=N              number of files to create [128]  -------生成测试文件的数量
  --file-block-size=N       block size to use in all IO operations [16384] ------测试期间文件块的大小。InnoDB存储引擎，每个页面的大小为16k 也就是16*1024=16384。
  --file-total-size=SIZE    total size of files to create [2G] ----每个文件的大小
  --file-test-mode=STRING   test mode {seqwr, seqrewr, seqrd, rndrd, rndwr, rndrw}-------文件测试模式，seqwr-顺序写 seqrewr-顺序读写 seqrd-顺序读 rndrd-随机读 rndwr-随机写 rndrw-随机读写
  --file-io-mode=STRING     file operations mode {sync,async,mmap} [sync]---文件操作的模式，同步、异步、MMAP（map映射）
  --file-extra-flags=STRING additional flags to use on opening files {sync,dsync,direct} []------打开文件时的选项，与API相关的参数
  --file-fsync-freq=N       do fsync() after this number of requests (0 - don't use fsync()) [100]--------执行fsync函数的频率。fsync主要是同步磁盘文件，因为可能有系统和磁盘缓冲的关系。
  --file-fsync-all[=on|off] do fsync() after each write operation [off]-----没执行完一次写操作，就执行一次fsync。默认关闭
  --file-fsync-end[=on|off] do fsync() at the end of test [on]----在测试结束时，执行fsync。默认 on
  --file-fsync-mode=STRING  which method to use for synchronization {fsync, fdatasync} [fsync]----文件同步函数的选择，多个操作系统对fdatasync支持的不同，不建议使用fdatasync。默认为fsync。
  --file-merged-requests=N  merge at most this number of IO requests if possible (0 - don't merge) [0]-------尽可能的合并N个IO请求数，0表示不合并，默认值：0。
  --file-rw-ratio=N         reads/writes ratio for combined test [1.5]-----测试时的读写比例 默认是2：1

➜  mysqldata git:(master) ✗

```

#### 案例
```
## 1. prepare 准备阶段，生产需要的测试文件
sysbench --test=fileio --file-num=4 --file-block-size=16384 --file-total-size=1G --file-test-mode=seqrd prepare
WARNING: the --test option is deprecated. You can pass a script name or path on the command line without any options.
sysbench 1.0.11 (using bundled LuaJIT 2.1.0-beta2)

4 files, 262144Kb each, 1024Mb total
Creating files for the test...
Extra file open flags: 0
Creating file test_file.0
Creating file test_file.1
Creating file test_file.2
Creating file test_file.3
1073741824 bytes written in 16.42 seconds (62.34 MiB/sec).

//  --file-num=4 生成4个文件
// --file-block-size=16384 块大小16k 
// --file-total-size=1G 总大小1G 所以每个文件是256M
➜  mysqldata git:(master) ✗ ll test*
-rw-------  1 ShaoGaoJie  staff  268435456  1 13 11:13 test_file.0  
-rw-------  1 ShaoGaoJie  staff  268435456  1 13 11:13 test_file.1
-rw-------  1 ShaoGaoJie  staff  268435456  1 13 11:13 test_file.2
-rw-------  1 ShaoGaoJie  staff  268435456  1 13 11:13 test_file.3


## 2. run 实际测试阶段

➜  mysqldata git:(master) ✗ sysbench --test=fileio --file-num=4 --file-block-size=16384 --file-total-size=1G --file-test-mode=rndrw run
WARNING: the --test option is deprecated. You can pass a script name or path on the command line without any options.
sysbench 1.0.11 (using bundled LuaJIT 2.1.0-beta2)

Running the test with following options:
Number of threads: 1
Initializing random number generator from current time


Extra file open flags: 0
4 files, 256MiB each
1GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      1379.51
    writes/s:                     919.68
    fsyncs/s:                     91.87

Throughput:
    read, MiB/s:                  21.55
    written, MiB/s:               14.37

General statistics:
    total time:                          10.0009s
    total number of events:              23919

Latency (ms):
         min:                                  0.01
         avg:                                  0.41
         max:                                 82.61
         95th percentile:                      1.61
         sum:                               9823.76

Threads fairness:
    events (avg/stddev):           23919.0000/0.00
    execution time (avg/stddev):   9.8238/0.00

➜  mysqldata git:(master) ✗



## 3. cleanup 清理测试产生的文件

sysbench --test=fileio --file-num=4 --file-block-size=16384 --file-total-size=1G --file-test-mode=rndrw cleanup
WARNING: the --test option is deprecated. You can pass a script name or path on the command line without any options.
sysbench 1.0.11 (using bundled LuaJIT 2.1.0-beta2)

Removing test files...
➜  mysqldata git:(master) ✗


```


### oltp测试
```
## 1. prepare阶段会根据选项产生指定行数的表。
sysbench --db-driver=mysql --mysql-user=root --mysql-password='' --mysql-socket=/tmp/mysql.sock --mysql-db=test --range_size=100 --table_size=10000 --tables=2 --threads=1 --events=0 --time=60 --rand-type=uniform /usr/local/Cellar/sysbench/1.0.11_1/share/sysbench/oltp_read_only.lua prepare
sysbench 1.0.11 (using bundled LuaJIT 2.1.0-beta2)

Creating table 'sbtest1'...
Inserting 10000 records into 'sbtest1'
Creating a secondary index on 'sbtest1'...
Creating table 'sbtest2'...
Inserting 10000 records into 'sbtest2'
Creating a secondary index on 'sbtest2'...



(root@localhost)[test]> show tables like 'sb%';
+----------------------+
| Tables_in_test (sb%) |
+----------------------+
| sbtest1              |
| sbtest2              |
+----------------------+
2 rows in set (0.01 sec)


## 执行

➜  sysbench sysbench --db-driver=mysql --mysql-user=root --mysql-password='' --mysql-socket=/tmp/mysql.sock --mysql-db=test --range_size=100 --table_size=10000 --tables=2 --threads=1 --events=0 --time=60 --rand-type=uniform /usr/local/Cellar/sysbench/1.0.11_1/share/sysbench/oltp_read_only.lua run
sysbench 1.0.11 (using bundled LuaJIT 2.1.0-beta2)

Running the test with following options:
Number of threads: 1
Initializing random number generator from current time


Initializing worker threads...

Threads started!

SQL statistics:
    queries performed:
        read:                            159082
        write:                           0
        other:                           22726
        total:                           181808
    transactions:                        11363  (189.35 per sec.)
    queries:                             181808 (3029.61 per sec.)
    ignored errors:                      0      (0.00 per sec.)
    reconnects:                          0      (0.00 per sec.)

General statistics:
    total time:                          60.0080s
    total number of events:              11363

Latency (ms):
         min:                                  3.65
         avg:                                  5.28
         max:                                240.93
         95th percentile:                      7.17
         sum:                              59962.27

Threads fairness:
    events (avg/stddev):           11363.0000/0.00
    execution time (avg/stddev):   59.9623/0.00
    
    
    

## 3. cleanup  
➜  sysbench sysbench --db-driver=mysql --mysql-user=root --mysql-password='' --mysql-socket=/tmp/mysql.sock --mysql-db=test --range_size=100 --table_size=10000 --tables=2 --threads=1 --events=0 --time=60 --rand-type=uniform /usr/local/Cellar/sysbench/1.0.11_1/share/sysbench/oltp_read_only.lua cleanup
sysbench 1.0.11 (using bundled LuaJIT 2.1.0-beta2)

Dropping table 'sbtest1'...
Dropping table 'sbtest2'...
    
    
```